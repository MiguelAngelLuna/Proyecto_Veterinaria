@model IEnumerable<VeterinariaWebApp.Models.Mascota.Mascota>

@{
    ViewData["Title"] = "Mis Mascotas";
    Layout = "~/Views/Shared/_LayoutCliente.cshtml";
    var clienteId = Context.Session.GetInt32("ClienteId");
}

<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-dog text-primary me-2"></i> Mis Mascotas
        </h1>
        <a asp-action="AgregarMascota" class="btn btn-success shadow-sm">
            <i class="fas fa-plus-circle me-1"></i> Agregar Nueva Mascota
        </a>
    </div>

    <!-- Mensaje de éxito/error -->
    @if (TempData["Exito"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["Exito"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Tabla de mascotas -->
    <div class="card shadow mb-4 mt-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-table me-2"></i>Vista de Tabla
            </h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="dataTable" width="100%" cellspacing="0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Especie</th>
                            <th>Raza</th>
                            <th>Edad</th>
                            <th>F. Nacimiento</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td><span class="badge bg-secondary">#@item.IdMascota</span></td>
                                <td class="fw-bold">@item.Nombre</td>
                                <td>@item.Especie</td>
                                <td>@(string.IsNullOrEmpty(item.Raza) ? "-" : item.Raza)</td>
                                <td><span class="badge bg-success">@item.Edad</span></td>
                                <td>@item.FechaNacimiento.ToString("dd/MM/yyyy")</td>
                                <td class="text-center">
                                    <a href="@Url.Action("DetalleMascota", "Cliente", new { id = item.IdMascota })"
                                       class="btn btn-info btn-sm" title="Ver">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="@Url.Action("ActualizarMascota", "Cliente", new { id = item.IdMascota })"
                                       class="btn btn-warning btn-sm" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-danger btn-sm btn-eliminar-mascota"
                                            data-id="@item.IdMascota" data-nombre="@item.Nombre" title="Archivar">
                                        <i class="fas fa-archive"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.querySelectorAll('.btn-eliminar-mascota').forEach(btn => {
            btn.addEventListener('click', async function () {
                const idMascota = this.dataset.id;
                const nombreMascota = this.dataset.nombre;

                try {
                    // Primera llamada: verificar si hay citas pendientes
                    const response = await fetch(`/Cliente/EliminarMascota?id=${idMascota}`, {
                        method: 'DELETE',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const data = await response.json();

                    if (data.success) {
                        if (data.message?.includes('No puedes eliminar')) {
                            // Mostrar mensaje de confirmación
                            const { value: confirmar } = await Swal.fire({
                                title: '¿Cancelar citas?',
                                text: data.message,
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Sí, cancelar citas',
                                cancelButtonText: 'No',
                                reverseButtons: true
                            });

                            if (confirmar) {
                                // Segunda llamada: confirmar cancelación
                                const resp2 = await fetch(`/Cliente/EliminarMascota?id=${idMascota}&confirmar=true`, {
                                    method: 'DELETE',
                                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                                });
                                const data2 = await resp2.json();

                                if (data2.success) {
                                    Swal.fire('¡Eliminada!', data2.message, 'success').then(() => location.reload());
                                } else {
                                    Swal.fire('Error', data2.message || 'No se pudo archivar.', 'error');
                                }
                            }
                        } else {
                            // Éxito directo (sin citas pendientes)
                            Swal.fire('¡Archivada!', data.message, 'success').then(() => location.reload());
                        }
                    } else {
                        Swal.fire('Error', data.message || 'No se pudo eliminar la mascota.', 'error');
                    }
                } catch (error) {
                    Swal.fire('Error', 'Hubo un problema al eliminar la mascota.', 'error');
                }
            });
        });
    </script>
}

<style>
    .mascota-card {
        border: none;
        border-radius: 15px;
        transition: all 0.3s ease;
    }

        .mascota-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15) !important;
        }

        .mascota-card .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid #28a745;
            border-radius: 15px 15px 0 0 !important;
        }

    .emoji-icon {
        font-size: 2.5rem;
    }

    .mascota-info .info-item {
        padding: 8px 0;
        border-bottom: 1px dashed #e9ecef;
    }

        .mascota-info .info-item:last-child {
            border-bottom: none;
        }

    .border-left-success {
        border-left: 4px solid #28a745 !important;
    }

    .empty-state i {
        opacity: 0.3;
    }

    .btn-group .btn {
        border-radius: 0;
    }

        .btn-group .btn:first-child {
            border-radius: 5px 0 0 5px;
        }

        .btn-group .btn:last-child {
            border-radius: 0 5px 5px 0;
        }

    .table th {
        font-weight: 600;
        color: #495057;
        border-top: none;
    }

    .badge {
        font-weight: 500;
    }
</style>