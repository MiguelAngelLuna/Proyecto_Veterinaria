@model IEnumerable<VeterinariaWebApp.Models.Usuario.Veterinario.CitaVeterinario>

@{
    ViewData["Title"] = "Mis Citas Asignadas";
    Layout = "~/Views/Shared/_LayoutVeterinario.cshtml";
}

<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-calendar-check text-primary me-2"></i> Mis Citas Asignadas
        </h1>
    </div>

    <!-- Mensajes -->
    @if (TempData["Exito"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["Exito"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (!Model.Any())
    {
        <!-- Estado vacío -->
        <div class="card shadow-sm">
            <div class="card-body text-center py-5">
                <div class="empty-state">
                    <i class="fas fa-calendar-times fa-5x text-muted mb-4"></i>
                    <h4 class="text-muted">No tienes citas asignadas</h4>
                    <p class="text-muted">Las citas aparecerán aquí cuando los clientes las agenden contigo.</p>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Resumen por estados -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Total de Citas
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.Count(c => c.est_cit != "C")</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    Pendientes
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">
                                    @Model.Count(c => c.est_cit == "P")
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clock fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    En Atención
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">
                                    @Model.Count(c => c.est_cit == "E")
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-stethoscope fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Atendidas
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">
                                    @Model.Count(c => c.est_cit == "A")
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Citas Pendientes (prioritarias) -->
        
            var citasPendientes = Model.Where(c => c.est_cit == "P").OrderBy(c => c.cal_cit).ToList();
            var citasEnAtencion = Model.Where(c => c.est_cit == "E").ToList();
            var citasAtendidas = Model.Where(c => c.est_cit == "A").OrderByDescending(c => c.cal_cit).ToList();
        

        @if (citasEnAtencion.Any())
        {
            <div class="card shadow mb-4 border-info">
                <div class="card-header py-3 bg-info text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-stethoscope me-2"></i>En Atención Actualmente (@citasEnAtencion.Count())
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        @foreach (var cita in citasEnAtencion)
                        {
                            <div class="col-xl-4 col-lg-6 mb-4">
                                <div class="card cita-card shadow h-100 border-info border-3">
                                    <div class="card-header py-3 bg-info-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <span class="fs-2 me-2">@cita.EspecieEmoji</span>
                                                <div>
                                                    <h6 class="mb-0 fw-bold">@cita.mascota</h6>
                                                    <small class="text-muted">@cita.especie</small>
                                                </div>
                                            </div>
                                            <span class="badge bg-info fs-6">
                                                <i class="fas fa-stethoscope me-1"></i>En Atención
                                            </span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="info-item mb-2">
                                            <i class="fas fa-calendar text-info me-2"></i>
                                            <strong>@cita.cal_cit.ToString("dd/MM/yyyy")</strong> a las 
                                            <strong>@cita.cal_cit.ToString("hh:mm tt")</strong>
                                        </div>
                                        <div class="info-item mb-2">
                                            <i class="fas fa-door-open text-info me-2"></i>
                                            Consultorio: <strong>@cita.con_cit</strong>
                                        </div>
                                        <div class="info-item mb-2">
                                            <i class="fas fa-user text-info me-2"></i>
                                            Dueño: <strong>@cita.nombre_dueno</strong>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-transparent">
                                        <a href="@Url.Action("AtenderCita", "Veterinario", new { id = cita.ide_cit })" 
                                           class="btn btn-info w-100">
                                            <i class="fas fa-clipboard-list me-2"></i>Continuar Atención
                                        </a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        @if (citasPendientes.Any())
        {
            <div class="card shadow mb-4 border-warning">
                <div class="card-header py-3 bg-warning">
                    <h6 class="m-0 font-weight-bold text-dark">
                        <i class="fas fa-clock me-2"></i>Citas Pendientes (@citasPendientes.Count())
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        @foreach (var cita in citasPendientes)
                        {
                            var esHoy = cita.cal_cit.Date == DateTime.Today;
                            <div class="col-xl-4 col-lg-6 mb-4">
                                <div class="card cita-card shadow h-100 @(esHoy ? "border-danger border-2" : "border-warning")">
                                    <div class="card-header py-3 @(esHoy ? "bg-danger-light" : "bg-warning-light")">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <span class="fs-2 me-2">@cita.EspecieEmoji</span>
                                                <div>
                                                    <h6 class="mb-0 fw-bold">@cita.mascota</h6>
                                                    <small class="text-muted">@cita.especie</small>
                                                </div>
                                            </div>
                                            @if (esHoy)
                                            {
                                                <span class="badge bg-danger fs-6">
                                                    <i class="fas fa-exclamation-circle me-1"></i>HOY
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fas fa-clock me-1"></i>Pendiente
                                                </span>
                                            }
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="info-item mb-2">
                                            <i class="fas fa-calendar text-primary me-2"></i>
                                            <strong>@cita.cal_cit.ToString("dddd, dd MMM yyyy")</strong>
                                        </div>
                                        <div class="info-item mb-2">
                                            <i class="fas fa-clock text-primary me-2"></i>
                                            Hora: <span class="fs-5 fw-bold text-primary">@cita.cal_cit.ToString("hh:mm tt")</span>
                                        </div>
                                        <div class="info-item mb-2">
                                            <i class="fas fa-door-open text-primary me-2"></i>
                                            Consultorio: <strong>@cita.con_cit</strong>
                                        </div>
                                        <hr>
                                        <div class="info-item mb-2">
                                            <i class="fas fa-user text-secondary me-2"></i>
                                            Dueño: <strong>@cita.nombre_dueno</strong>
                                        </div>
                                        <div class="info-item mb-2">
                                            <i class="fas fa-id-card text-secondary me-2"></i>
                                            Doc: <strong>@cita.doc_dueno</strong>
                                        </div>
                                        <div class="info-item">
                                            <i class="fas fa-money-bill-wave text-success me-2"></i>
                                            Monto: <span class="badge bg-success">S/ @cita.mon_pag.ToString("N2")</span>
                                            <small class="text-muted">(@cita.nom_pay)</small>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-transparent">
                                        <a href="@Url.Action("IniciarAtencion", "Veterinario", new { id = cita.ide_cit })" 
                                           class="btn btn-success w-100 btn-lg">
                                            <i class="fas fa-play-circle me-2"></i>Iniciar Atención
                                        </a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        @if (citasAtendidas.Any())
        {
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-success text-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-check-circle me-2"></i>Citas Atendidas (@citasAtendidas.Count())
                    </h6>
                    <button class="btn btn-light btn-sm" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#collapseAtendidas" aria-expanded="false">
                        <i class="fas fa-chevron-down"></i> Ver/Ocultar
                    </button>
                </div>
                <div class="collapse" id="collapseAtendidas">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Mascota</th>
                                        <th>Especie</th>
                                        <th>Dueño</th>
                                        <th>Consultorio</th>
                                        <th>Monto</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var cita in citasAtendidas.Take(10))
                                    {
                                        <tr>
                                            <td>
                                                <strong>@cita.cal_cit.ToString("dd/MM/yyyy")</strong><br>
                                                <small class="text-muted">@cita.cal_cit.ToString("hh:mm tt")</small>
                                            </td>
                                            <td>
                                                <span class="me-1">@cita.EspecieEmoji</span>
                                                <strong>@cita.mascota</strong>
                                            </td>
                                            <td>@cita.especie</td>
                                            <td>@cita.nombre_dueno</td>
                                            <td>@cita.con_cit</td>
                                            <td><span class="badge bg-success">S/ @cita.mon_pag.ToString("N2")</span></td>
                                            <td>
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check-circle me-1"></i>Atendida
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                            @if (citasAtendidas.Count() > 10)
                            {
                                <p class="text-muted text-center">Mostrando las últimas 10 citas atendidas de @citasAtendidas.Count() totales.</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Auto-cerrar alertas después de 5 segundos
            setTimeout(function () {
                var alerts = document.querySelectorAll('.alert');
                alerts.forEach(function (alert) {
                    if (bootstrap && bootstrap.Alert) {
                        var bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                });
            }, 5000);
        });
    </script>
}

<style>
    .cita-card {
        border-radius: 15px;
        transition: all 0.3s ease;
    }

    .cita-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15) !important;
    }

    .cita-card .card-header {
        border-radius: 13px 13px 0 0 !important;
    }

    .bg-success-light { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); }
    .bg-warning-light { background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%); }
    .bg-info-light { background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); }
    .bg-danger-light { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); }

    .border-left-primary { border-left: 4px solid #4e73df !important; }
    .border-left-success { border-left: 4px solid #28a745 !important; }
    .border-left-warning { border-left: 4px solid #ffc107 !important; }
    .border-left-info { border-left: 4px solid #17a2b8 !important; }

    .info-item {
        padding: 5px 0;
    }

    .empty-state i {
        opacity: 0.3;
    }
</style>
